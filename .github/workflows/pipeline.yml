name: CI-CD Spring Boot (no Docker)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    name: CI - Build & Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build and test with Maven
        run: mvn -B clean verify

  delivery:
    name: CD - Package JAR (Delivery)
    runs-on: ubuntu-latest
    needs: ci   # n'exÃ©cute que si la CI est OK

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Package application (JAR)
        run: mvn -B clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: foodtruck-api-jar
          path: target/*.jar

deploy:
  name: CD - Deploy to server (no systemctl)
  runs-on: ubuntu-latest
  needs: delivery
  if: github.ref == 'refs/heads/main'

  steps:
    - name: Download JAR artifact
      uses: actions/download-artifact@v4
      with:
        name: foodtruck-api-jar
        path: build

    - name: Prepare SSH key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Ensure app directory exists on server
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          mkdir -p '${{ secrets.APP_DIR }}'
        "

    - name: Copy JAR to server
      run: |
        scp -P ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no \
          build/*.jar \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:'${{ secrets.APP_DIR }}/app.jar'

    - name: Restart app on server using run.sh
      run: |
        ssh -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
          cd '${{ secrets.APP_DIR }}' && ./run.sh
        "